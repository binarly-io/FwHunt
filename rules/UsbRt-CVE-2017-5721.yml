UsbRt-CVE-2017-5721:
  meta:
    author:       Binarly (https://github.com/binarly-io/FwHunt)
    license:      CC0-1.0
    name:         UsbRt-CVE-2017-5721
    version:      1.0
    namespace:    vulnerabilities
    CVE number:   CVE-2017-5721
    vendor id:    INTEL-SA-00084
    CVSS score:   7.5 High
    advisory:     https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00084.html
    description:  Detection for SMM callout in SW SMI handler on multiple Intel server platforms
  code:
    0:
      pattern: 0fb704250e040000ba2f000000c1e00405040100008b38
        # 0fb704250e040000                    movzx   eax, word ptr ds:40Eh
        # ba2f000000                          mov     edx, 2Fh
        # c1e004                              shl     eax, 4
        # 0504010000                          add     eax, 104h
        # 8b38                                mov     edi, [rax]
      place:
        - sw_smi_handlers
    1:
      pattern: 488d15........0fb6c0488bcfff
        # 488d1544f2ffff                      lea     rdx, funcs_1C42
        # 0fb6c0                              movzx   eax, al
        # 488bcf                              mov     rcx, rdi
        # ff14c2                              call    ds:(UsbApiTable - 80000E80h)[rdx+rax*8]
      place:
        - sw_smi_handlers
  hex_strings:
    0: d2e2d82a912ed14c95f5e78fe5ebe316 # EFI_USB_PROTOCOL_GUID in .text segment
    1: 448b490b448b410f488b05........488bd90fb649014183c1f0488b530349c1e9044183c0034f8d14494183e0fc49c1e2064d8d4c0270498b4cc908e8
        # 448b490b                            mov     r9d, [rcx+11]
        # 448b410f                            mov     r8d, [rcx+15]
        # 488b0513610100                      mov     rax, cs:gUsbData
        # 488bd9                              mov     rbx, rcx
        # 0fb64901                            movzx   ecx, byte ptr [rcx+1]
        # 4183c1f0                            add     r9d, 0FFFFFFF0h
        # 488b5303                            mov     rdx, [rbx+3]
        # 49c1e904                            shr     r9, 4
        # 4183c003                            add     r8d, 3
        # 4f8d1449                            lea     r10, [r9+r9*2]
        # 4183e0fc                            and     r8d, 0FFFFFFFCh
        # 49c1e206                            shl     r10, 6
        # 4d8d4c0270                          lea     r9, [r10+rax+70h]
        # 498b4cc908                          mov     rcx, [r9+rcx*8+8]
        # e8a9feffff                          call    Invoke
